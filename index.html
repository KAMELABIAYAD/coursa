<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>COURSA ‚Äî Boutique</title>
  <style>
    :root{--accent:#1f7aec;--accent2:#ff7a59;--card:#ffffff;--bg1:#f0f7ff;--bg2:#fef7f2;--muted:#6b7280}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter, Arial, sans-serif;background:linear-gradient(90deg,var(--bg1),var(--bg2));color:#111}
    .wrap{max-width:1100px;margin:24px auto;padding:16px}
    header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:rgba(255,255,255,0.9);border-radius:10px;box-shadow:0 6px 18px rgba(16,24,40,0.06)}
    .brand{display:flex;gap:12px;align-items:center}
    .brand .logo{font-weight:800;letter-spacing:2px;font-size:20px}
    .supplier-line{font-size:13px;color:var(--muted);text-align:right}
    nav{display:flex;gap:10px;align-items:center}
    nav button{padding:8px 12px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);background:white;cursor:pointer}
    main{margin-top:18px}
    .card{background:white;padding:16px;border-radius:10px;box-shadow:0 6px 18px rgba(16,24,40,0.04)}
    .center{display:flex;flex-direction:column;gap:14px;align-items:center;justify-content:center;padding:30px}
    .big-btn{padding:12px 18px;border-radius:10px;background:linear-gradient(90deg,var(--accent),#2389ff);color:white;border:none;cursor:pointer}
    .layout{display:grid;grid-template-columns:1fr 360px;gap:18px;margin-top:18px}
    .products{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
    .product{background:#fff;border-radius:10px;padding:12px;border:1px solid #eef2f6;display:flex;flex-direction:column;gap:8px}
    .product .card-img-wrap{position:relative}
    .product img{width:100%;height:160px;object-fit:cover;border-radius:8px;cursor:pointer;display:block}
    .productThumbs{display:flex;gap:6px;margin-top:6px}
    .productThumbs img{width:44px;height:44px;object-fit:cover;border-radius:6px;border:1px solid #eee;cursor:pointer}
    .product h3{margin:0;font-size:16px}
    .price{color:var(--accent2);font-weight:700}
    .qty-controls{display:flex;gap:8px;align-items:center}
    .small-btn{padding:6px 8px;border-radius:6px;border:1px solid #e6eef8;background:white;cursor:pointer}
    .cart-list{display:flex;flex-direction:column;gap:8px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #f1f5f9}
    .modal{position:fixed;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:60}
    .modal .panel{background:white;padding:16px;border-radius:10px;max-width:920px;width:96%;max-height:90vh;overflow:auto}
    .modal .images{display:flex;gap:8px}
    .thumb{width:72px;height:72px;object-fit:cover;border-radius:6px;border:1px solid #eee;cursor:pointer}
    .zoom-img{max-width:100%;max-height:60vh;transition:transform 0.12s ease}
    .image-stage{position:relative;height:60vh;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .image-stage img{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);max-width:100%;max-height:100%;transition:transform 0.4s ease,opacity 0.35s ease}
    .image-slide-enter-right{transform:translate(-40%,-50%) scale(1); opacity:0}
    .image-slide-enter-left{transform:translate(-60%,-50%) scale(1); opacity:0}
    .image-slide-active{transform:translate(-50%,-50%) scale(1); opacity:1}
    .image-arrow{position:absolute;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.9);border-radius:30px;padding:8px 10px;border:0;cursor:pointer;box-shadow:0 6px 18px rgba(2,6,23,0.08)}
    .image-arrow.left{left:8px}
    .image-arrow.right{right:8px}
    .image-reset{position:absolute;left:50%;transform:translateX(-50%);bottom:12px;z-index:80}
    @media(max-width:900px){.layout{grid-template-columns:1fr;}.products{grid-template-columns:repeat(1,minmax(0,1fr));}.product img{height:220px}.wrap{padding:12px}}
    .muted{color:var(--muted);font-size:13px}
    .row{display:flex;gap:8px;align-items:center}
    .input,button.input{padding:8px;border-radius:8px;border:1px solid #e6eef8;background:white}
    .danger{background:#fee2e2;color:#991b1b}
    .success{background:#ecfdf5;color:#065f46}
    .badge{background:var(--accent2);color:white;padding:4px 8px;border-radius:999px;font-size:12px}
    .lang-buttons{display:flex;gap:8px;justify-content:center;margin-top:8px}
    .lang-btn{padding:6px 10px;border-radius:8px;border:1px solid rgba(0,0,0,0.08);background:white;cursor:pointer}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div style="width:52px;height:52px;border-radius:10px;background:linear-gradient(180deg,#fff,#f2f9ff);display:flex;align-items:center;justify-content:center;font-weight:800" id="brandLogoLetter">C</div>
        <div>
          <div class="logo" id="brandLogo">COURSA</div>
          <div class="muted" id="brandSub">Marketplace</div>
        </div>
      </div>
      <div class="supplier-line" id="supplierHeader">Fournisseur: Kamel Abiyad ‚Äî 05 40 14 80 69</div>
    </header>

    <main id="mainArea">
      <!-- initial screen (only connect + supplier link visible) -->
      <section id="initialScreen" class="card center">
        <h2 id="welcomeTitle">Bienvenue sur Coursa</h2>
        <p class="muted" id="welcomeSub">Connectez-vous pour commencer</p>

        <div class="lang-buttons" style="width:100%;justify-content:center">
          <button class="lang-btn" id="langFrBtn" onclick="setLanguage('fr')">Fran√ßais</button>
          <button class="lang-btn" id="langArBtn" onclick="setLanguage('ar')">ÿπÿ±ÿ®Ÿä</button>
        </div>

        <div class="row" style="margin-top:6px">
          <button class="big-btn" id="connectBtn" onclick="openClientAuth()">üîë Connecter</button>
          <button class="input" id="supplierBtnInit" onclick="openSupplierLogin()">‚öôÔ∏è Fournisseur</button>
        </div>
        <div class="muted" style="margin-top:8px" id="supplierProtected">(L'espace fournisseur est prot√©g√© par mot de passe)</div>
        <div style="margin-top:18px;text-align:center" id="pendingNotice"></div>
      </section>

      <!-- home layout (hidden by default) -->
      <section id="homeScreen" style="display:none">
        <div class="layout">
          <div>
            <div class="card">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                <div>
                  <h3 id="productsTitle">Produits</h3>
                  <div class="muted" id="productsSub">Explore les produits disponibles</div>
                </div>
                <div class="row">
                  <input class="input" id="searchInput" placeholder="Rechercher..." oninput="renderProducts()">
                  <button class="input" onclick="openSupplierLogin()" id="supplierBtnHeader">Fournisseur</button>
                </div>
              </div>

              <div class="products" id="productsGrid"></div>
            </div>
          </div>

          <aside>
            <div class="card" style="margin-bottom:12px">
              <h4 id="cartTitle">Panier</h4>
              <div id="cartList" class="cart-list"><div class="muted">Panier vide</div></div>
              <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px"><div class="muted" id="totalLabel">Total</div><div id="cartTotal">0 DA</div></div>
              <div style="margin-top:10px;display:flex;gap:8px">
                <button onclick="openCartCheckout()" class="big-btn" id="orderBtn">Bon de commande</button>
                <button class="input" onclick="clearCart()" id="clearCartBtn">Vider</button>
              </div>
            </div>

            <!-- Mes commandes sous le panier -->
            <div class="card" style="margin-bottom:12px" id="clientOrdersCard">
              <h4>Mes commandes</h4>
              <div id="clientOrdersList" class="cart-list muted">Aucune commande</div>
            </div>

            <div class="card">
              <h4 id="accountTitle">Compte</h4>
              <div id="accountBlock"></div>
            </div>
          </aside>
        </div>
      </section>

      <!-- supplier login panel -->
      <section id="supplierLoginSection" class="card" style="display:none">
        <h3 id="supplierLoginHeader">Connexion Fournisseur</h3>
        <div class="row" style="margin-top:8px">
          <input id="supplierPwd" class="input" placeholder="Mot de passe">
          <button onclick="supplierLogin()" id="supplierEnterBtn">Entrer</button>
          <button onclick="closeSupplierLogin()" class="input" id="supplierCancelBtn">Annuler</button>
          <div style="margin-left:12px" id="supplierNotif"></div>
        </div>
      </section>

      <!-- supplier dashboard -->
      <section id="supplierPanelSection" style="display:none">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <h3 id="supplierPanelTitle">Tableau Fournisseur</h3>
              <div class="muted" id="supplierPanelSub">G√©rer clients, produits et commandes</div>
            </div>
            <div class="row">
              <div class="muted" id="supplierNameDisplay">Kamel Abiyad</div>
              <button class="input" onclick="logoutSupplier()" id="supplierLogoutBtn">Se d√©connecter</button>
            </div>
          </div>

          <div style="display:flex;gap:12px;margin-top:14px;flex-wrap:wrap">
            <button class="input" onclick="showSupplierTab('clients')">Clients (<span id="pendingCount">0</span>)</button>
            <button class="input" onclick="showSupplierTab('products')">Produits</button>
            <button class="input" onclick="showSupplierTab('orders')">Banc de commandes</button>
          </div>

          <div id="supplierTabs" style="margin-top:14px"></div>
        </div>
      </section>

    </main>
  </div>

  <!-- client auth modal (persistent in DOM) -->
  <div class="modal" id="clientAuthModal">
    <div class="panel">
      <h3 id="clientAuthHeader">Se connecter / Cr√©er compte</h3>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button onclick="renderClientForm('exist')" id="haveAccountBtn">J'ai d√©j√† un compte</button>
        <button onclick="renderClientForm('new')" id="createAccountBtn">Cr√©er un compte</button>
      </div>
      <div id="clientFormArea" style="margin-top:12px"></div>
      <div style="margin-top:12px;text-align:right"><button onclick="closeClientForm()" id="closeClientFormBtn">Fermer</button></div>
    </div>
  </div>

  <!-- product modal (gallery + add qty) -->
  <div class="modal" id="productModal">
    <div class="panel">
      <div style="display:flex;gap:12px;align-items:flex-start">
        <div style="flex:1">
          <div id="productModalImages">
            <img id="productMainImg" class="zoom-img" src="" alt="">
            <div class="productThumbs" id="productThumbs" style="margin-top:8px"></div>
          </div>
        </div>
        <div style="width:320px">
          <h3 id="modalTitle"></h3>
          <div class="muted" id="modalDesc"></div>
          <div style="margin-top:12px" class="row"><button onclick="decreaseModalQty()">-</button><input id="modalQty" value="1" style="width:60px;text-align:center" class="input"><button onclick="increaseModalQty()">+</button></div>
          <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center"><div class="price" id="modalPrice">0 DA</div><button class="big-btn" id="modalAddBtn" onclick="addFromModal()">Ajouter</button></div>
        </div>
      </div>
      <div style="margin-top:12px;text-align:right"><button onclick="closeProductModal()" class="input" id="closeProductModalBtn">Fermer</button></div>
    </div>
  </div>

  <!-- image-only modal (for clicking product image in grid) -->
  <div class="modal" id="imageModal">
    <div class="panel" id="imagePanel">
      <div style="text-align:center;position:relative">
        <div class="image-stage" id="imageStage" style="height:60vh">
          <!-- images will be injected here -->
        </div>
        <button class="image-arrow left" onclick="prevImage()" aria-label="Prev">‚óÄ</button>
        <button class="image-arrow right" onclick="nextImage()" aria-label="Next">‚ñ∂</button>
        <div style="margin-top:12px;text-align:right" class="image-reset">
          <button onclick="resetImageZoom()" class="input">Reset</button>
          <button onclick="closeImageModal()" class="input">Fermer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- invoice modal -->
  <div class="modal" id="invoiceModal">
    <div class="panel" id="invoicePanel"></div>
  </div>

  <!-- Firebase libs (compat mode for easier migration) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <script>
    /* ------------------------
       Traductions FR / AR
       ------------------------ */
    const TRANSLATIONS = {
      fr: {
        logo: "COURSA",
        logoLetter: "C",
        marketplace: "Marketplace",
        supplier_line: "Fournisseur: Kamel Abiyad ‚Äî 05 40 14 80 69",
        welcome_title: "Bienvenue sur Coursa",
        welcome_sub: "Connectez-vous pour commencer",
        connect: "üîë Connecter",
        supplier: "‚öôÔ∏è Fournisseur",
        supplier_protected: "(L'espace fournisseur est prot√©g√© par mot de passe)",
        account_registered: "Compte enregistr√©",
        account_pending_description: "Votre compte ({name}) est en attente de validation par le fournisseur.",
        products: "Produits",
        products_sub: "Explore les produits disponibles",
        search_placeholder: "Rechercher...",
        cart: "Panier",
        cart_empty: "Panier vide",
        total: "Total",
        order_btn: "Bon de commande",
        clear_cart: "Vider",
        account: "Compte",
        no_client_connected: "Aucun client connect√©",
        client_auth_btn: "Se connecter / Cr√©er compte",
        client_auth_header: "Se connecter / Cr√©er compte",
        have_account: "J'ai d√©j√† un compte",
        create_account: "Cr√©er un compte",
        name: "Nom",
        surname: "Pr√©nom",
        phone: "T√©l√©phone",
        location: "Localisation",
        save: "Enregistrer",
        login: "Se connecter",
        supplier_login_header: "Connexion Fournisseur",
        password: "Mot de passe",
        enter: "Entrer",
        cancel: "Annuler",
        supplier_panel: "Tableau Fournisseur",
        supplier_sub: "G√©rer clients, produits et commandes",
        clients: "Clients",
        products_btn: "Produits",
        orders_btn: "Banc de commandes",
        clients_pending: "En attente",
        clients_validated: "Valid√©s",
        no_clients_pending: "Aucun client en attente",
        no_clients_validated: "Aucun client valid√©",
        accept: "Accepter",
        reject: "Refuser",
        delete: "Supprimer",
        no_products: "Aucun produit",
        add_product: "Ajouter",
        edit: "Modifier",
        bank_orders: "Banc de commandes",
        no_orders: "Aucune commande",
        total_revenue: "CA total",
        product_added: "Produit ajout√©",
        product_modified: "Produit modifi√©",
        product_deleted: "Produit supprim√©",
        fill_required: "Remplis les champs requis",
        location_required: "La localisation est requise",
        account_created_pending: "Compte cr√©√© et en attente de validation",
        account_not_found: "Compte introuvable ou non valid√©",
        incorrect_password: "Mot de passe incorrect",
        client_validated: "Client valid√©",
        client_refused: "Client refus√©",
        client_deleted: "Client supprim√©",
        product_not_found: "Produit introuvable",
        title_price_required: "Titre et prix requis",
        must_be_logged: "Tu dois √™tre connect√© et valid√© pour passer commande",
        invoice_title: "Bon de commande",
        order_saved: "Commande enregistr√©e",
        close: "Fermer",
        article: "Article",
        qty: "Qt√©",
        price: "Prix",
        account_not_validated: "Compte non valid√©",
        preview: "Aper√ßu client",
        preview_sub: "Tester le site c√¥t√© client sans se d√©connecter",
        preview_cart: "Panier (Aper√ßu)",
        preview_cart_empty: "Panier aper√ßu vide",
        confirm_preview: "Confirmer (Aper√ßu)",
        preview_invoice_title: "Bon de commande (Aper√ßu)",
        preview_not_saved: "Aper√ßu client ‚Äî pas enregistr√©",
        preview_btn: "Aper√ßu client"
      },
      ar: {
        logo: "ŸÉŸàÿ±ÿ≥ÿß",
        logoLetter: "ŸÉ",
        marketplace: "ÿ≥ŸàŸÇ",
        supplier_line: "ÿßŸÑŸÖŸàÿ±ÿØ: Kamel Abiyad ‚Äî 05 40 14 80 69",
        welcome_title: "ŸÖÿ±ÿ≠ÿ®ÿß ÿ®ŸÉ ŸÅŸä ŸÉŸàÿ±ÿ≥ÿß",
        welcome_sub: "ÿ≥ÿ¨ŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÑŸÑÿ®ÿØÿ°",
        connect: "üîë ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ",
        supplier: "‚öôÔ∏è ŸÖŸàÿ±ÿØ",
        supplier_protected: "(ŸÖÿ≥ÿßÿ≠ÿ© ÿßŸÑŸÖŸàÿ±ÿØ ŸÖÿ≠ŸÖŸäÿ© ÿ®ŸÉŸÑŸÖÿ© ŸÖÿ±Ÿàÿ±)",
        account_registered: "ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ≠ÿ≥ÿßÿ®",
        account_pending_description: "ÿ≠ÿ≥ÿßÿ®ŸÉ ({name}) ŸÇŸäÿØ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ± ŸÑŸÖŸàÿßŸÅŸÇÿ© ÿßŸÑŸÖŸàÿ±ÿØ.",
        products: "ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™",
        products_sub: "ÿßÿ≥ÿ™ÿπÿ±ÿ∂ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©",
        search_placeholder: "ÿßÿ®ÿ≠ÿ´...",
        cart: "ÿπÿ±ÿ®ÿ© ÿßŸÑÿ™ÿ≥ŸàŸÇ",
        cart_empty: "ÿßŸÑÿπÿ±ÿ®ÿ© ŸÅÿßÿ±ÿ∫ÿ©",
        total: "ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä",
        order_btn: "ÿ£ŸÖÿ± ÿ¥ÿ±ÿßÿ°",
        clear_cart: "ÿ™ŸÅÿ±Ÿäÿ∫",
        account: "ÿßŸÑÿ≠ÿ≥ÿßÿ®",
        no_client_connected: "ŸÑÿß ŸäŸàÿ¨ÿØ ÿ≤ÿ®ŸàŸÜ ŸÖÿ™ÿµŸÑ",
        client_auth_btn: "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ / ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ®",
        client_auth_header: "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ / ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ®",
        have_account: "ŸÑÿØŸä ÿ≠ÿ≥ÿßÿ® ÿ®ÿßŸÑŸÅÿπŸÑ",
        create_account: "ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ®",
        name: "ÿßŸÑÿßÿ≥ŸÖ",
        surname: "ÿßŸÑŸÑŸÇÿ®",
        phone: "ÿßŸÑŸáÿßÿ™ŸÅ",
        location: "ÿßŸÑŸÖŸàŸÇÿπ",
        save: "ÿ≠ŸÅÿ∏",
        login: "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ",
        supplier_login_header: "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ ÿßŸÑŸÖŸàÿ±ÿØ",
        password: "ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±",
        enter: "ÿØÿÆŸàŸÑ",
        cancel: "ÿ•ŸÑÿ∫ÿßÿ°",
        supplier_panel: "ŸÑŸàÿ≠ÿ© ÿßŸÑŸÖŸàÿ±ÿØ",
        supplier_sub: "ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ≤ÿ®ÿßÿ¶ŸÜ ŸàÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸàÿßŸÑÿ∑ŸÑÿ®ÿßÿ™",
        clients: "ÿßŸÑÿ≤ÿ®ÿßÿ¶ŸÜ",
        products_btn: "ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™",
        orders_btn: "ÿ≥ÿ¨ŸÑ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™",
        clients_pending: "ŸÇŸäÿØ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±",
        clients_validated: "ŸÖÿπÿ™ŸÖÿØŸàŸÜ",
        no_clients_pending: "ŸÑÿß ŸäŸàÿ¨ÿØ ÿ≤ÿ®ÿßÿ¶ŸÜ ŸÇŸäÿØ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±",
        no_clients_validated: "ŸÑÿß ŸäŸàÿ¨ÿØ ÿ≤ÿ®ÿßÿ¶ŸÜ ŸÖŸèÿπÿ™ŸÖÿØŸäŸÜ",
        accept: "ŸÇÿ®ŸàŸÑ",
        reject: "ÿ±ŸÅÿ∂",
        delete: "ÿ≠ÿ∞ŸÅ",
        no_products: "ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖŸÜÿ™ÿ¨ÿßÿ™",
        add_product: "ÿ•ÿ∂ÿßŸÅÿ©",
        edit: "ÿ™ÿπÿØŸäŸÑ",
        bank_orders: "ÿ≥ÿ¨ŸÑ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™",
        no_orders: "ŸÑÿß ŸäŸàÿ¨ÿØ ÿ∑ŸÑÿ®ÿßÿ™",
        total_revenue: "ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™",
        product_added: "ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨",
        product_modified: "ÿ™ŸÖ ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨",
        product_deleted: "ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÜÿ™ÿ¨",
        fill_required: "ÿßŸÖŸÑÿ£ ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©",
        location_required: "ÿßŸÑŸÖŸàŸÇÿπ ŸÖÿ∑ŸÑŸàÿ®",
        account_created_pending: "ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ≠ÿ≥ÿßÿ® ŸàŸáŸà ÿ®ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑÿ™ÿ≠ŸÇŸÇ",
        account_not_found: "ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ ÿ£Ÿà ÿ∫Ÿäÿ± ŸÖÿπÿ™ŸÖÿØ",
        incorrect_password: "ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©",
        client_validated: "ÿ™ŸÖ ÿßÿπÿ™ŸÖÿßÿØ ÿßŸÑÿ≤ÿ®ŸàŸÜ",
        client_refused: "ÿ™ŸÖ ÿ±ŸÅÿ∂ ÿßŸÑÿ≤ÿ®ŸàŸÜ",
        client_deleted: "ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ≤ÿ®ŸàŸÜ",
        product_not_found: "ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ",
        title_price_required: "ÿßŸÑÿπŸÜŸàÿßŸÜ ŸàÿßŸÑÿ≥ÿπÿ± ŸÖÿ∑ŸÑŸàÿ®ÿßŸÜ",
        must_be_logged: "ÿπŸÑŸäŸÉ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ Ÿàÿ£ŸÜ ŸäŸÉŸàŸÜ ÿ≠ÿ≥ÿßÿ®ŸÉ ŸÖÿπÿ™ŸÖÿØŸãÿß ŸÑÿ•ÿ™ŸÖÿßŸÖ ÿßŸÑÿ∑ŸÑÿ®",
        invoice_title: "ÿ£ŸÖÿ± ÿ¥ÿ±ÿßÿ°",
        order_saved: "ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ∑ŸÑÿ®",
        close: "ÿ•ÿ∫ŸÑÿßŸÇ",
        article: "ÿßŸÑÿµŸÜŸÅ",
        qty: "ÿßŸÑŸÉŸÖŸäÿ©",
        price: "ÿßŸÑÿ≥ÿπÿ±",
        account_not_validated: "ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿ∫Ÿäÿ± ŸÖÿπÿ™ŸÖÿØ",
        preview: "ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑÿπŸÖŸäŸÑ",
        preview_sub: "ÿßÿÆÿ™ÿ®ÿßÿ± ÿßŸÑŸÖŸàŸÇÿπ ŸÉÿ≤ÿßÿ¶ÿ± ÿØŸàŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨",
        preview_cart: "ÿπÿ±ÿ®ÿ© (ÿπÿ±ÿ∂)",
        preview_cart_empty: "ÿπÿ±ÿ®ÿ© ÿßŸÑÿπÿ±ÿ∂ ŸÅÿßÿ±ÿ∫ÿ©",
        confirm_preview: "ÿ™ÿ£ŸÉŸäÿØ (ÿπÿ±ÿ∂)",
        preview_invoice_title: "ÿ£ŸÖÿ± ÿ¥ÿ±ÿßÿ° (ÿπÿ±ÿ∂)",
        preview_not_saved: "ÿπÿ±ÿ∂ ÿßŸÑÿπŸÖŸäŸÑ ‚Äî ÿ∫Ÿäÿ± ŸÖÿ≠ŸÅŸàÿ∏",
        preview_btn: "ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑÿ≤ÿ®ŸàŸÜ"
      }
    };

    // Hardcoded supplier password (unchanged)
    const SUPPLIER_PWD = '7 juillet 1993';

    // In-memory app state (no localStorage for persistent data)
    let products = [];    // local cache filled by onSnapshot
    let clients = [];     // local cache filled by onSnapshot
    let orders = [];      // local cache filled by onSnapshot
    let currentClient = null; // logged in client (in-memory)
    let cart = [];        // cart persisted in Firestore per client

    // UI language
    let currentLang = 'fr';

    function t(key, vars) {
      const dict = TRANSLATIONS[currentLang] || TRANSLATIONS['fr'];
      let s = dict[key] || key;
      if (vars && typeof vars === 'object') {
        Object.keys(vars).forEach(k => { s = s.replace(`{${k}}`, vars[k]); });
      }
      return s;
    }

    function formatPrice(n){ return n+' DA'; }
    function byId(id){ return document.getElementById(id); }

    // --- Firebase initialization placeholder (replace with your config) ---
    // IMPORTANT: remplace la configuration ci-dessous par ta firebaseConfig
    // depuis la console Firebase. Ex :
    // const firebaseConfig = { apiKey: "...", authDomain: "...", projectId: "...", storageBucket: "...", messagingSenderId: "...", appId: "..." };
    const firebaseConfig = {
      // <-- COLLE ICI TA firebaseConfig (depuis Firebase Console) -->
      apiKey: "",
      authDomain: "",
      projectId: "",
      storageBucket: "",
      messagingSenderId: "",
      appId: ""
    };

    // initialize firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    // --- Real-time listeners ---
    function startRealtimeListeners(){
      // produits
      db.collection('produits').orderBy('created', 'desc').onSnapshot(snap => {
        products = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderProducts();
        renderSupplierProductsList(); // update supplier tab if open
      });

      // clients (we'll keep local cache for supplier view)
      db.collection('clients').orderBy('created', 'desc').onSnapshot(snap => {
        clients = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderSupplierPendingCount();
        renderSupplierClientsTab(); // refresh tab if visible
      });

      // commandes
      db.collection('commandes').orderBy('date', 'desc').onSnapshot(snap => {
        orders = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderSupplierOrdersTab();
        renderClientOrders(); // refresh client order list if logged in
      });
    }

    // --- init UI language and start listeners ---
    function applyLanguage(lang) {
      currentLang = lang;
      document.documentElement.lang = (lang === 'ar') ? 'ar' : 'fr';
      document.body.setAttribute('dir', (lang === 'ar') ? 'rtl' : 'ltr');

      // static elements
      byId('brandLogo').textContent = t('logo');
      byId('brandLogoLetter').textContent = t('logoLetter');
      byId('brandSub').textContent = t('marketplace');
      byId('supplierHeader').textContent = t('supplier_line');

      byId('welcomeTitle').textContent = t('welcome_title');
      byId('welcomeSub').textContent = t('welcome_sub');
      byId('connectBtn').textContent = t('connect');
      byId('supplierBtnInit').textContent = t('supplier');
      byId('supplierProtected').textContent = t('supplier_protected');

      byId('productsTitle').textContent = t('products');
      byId('productsSub').textContent = t('products_sub');
      byId('searchInput').placeholder = t('search_placeholder');
      byId('supplierBtnHeader').textContent = t('supplier');

      byId('cartTitle').textContent = t('cart');
      byId('totalLabel').textContent = t('total');
      byId('orderBtn').textContent = t('order_btn');
      byId('clearCartBtn').textContent = t('clear_cart');

      byId('accountTitle').textContent = t('account');

      byId('clientAuthHeader').textContent = t('client_auth_header');
      byId('haveAccountBtn').textContent = t('have_account');
      byId('createAccountBtn').textContent = t('create_account');
      byId('closeClientFormBtn').textContent = t('close');

      byId('supplierLoginHeader').textContent = t('supplier_login_header');
      byId('supplierEnterBtn').textContent = t('enter');
      byId('supplierCancelBtn').textContent = t('cancel');

      byId('supplierPanelTitle').textContent = t('supplier_panel');
      byId('supplierPanelSub').textContent = t('supplier_sub');

      renderAccountBlock();
      renderProducts();
      renderCart();
      renderSupplierPendingCount();
      renderInitialPendingNotice();
    }

    function setLanguage(lang){ applyLanguage(lang); }

    // --- Helper UI functions (placeholders, image helpers) ---
    function placeholder(ti){ return 'data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='600' height='400'><rect width='100%' height='100%' fill='#f6f8fb'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='24' fill='#cbd5e1'>${ti}</text></svg>`); }

    // --- PRODUCTS: render from products[] (filled by snapshot) ---
    function getCartQty(productId){
      const it = cart.find(c=>c.id===productId);
      return it ? it.qty : 0;
    }

    async function renderProducts(){
      const grid = byId('productsGrid');
      grid.innerHTML='';
      const q = (byId('searchInput')?.value||'').toLowerCase();
      (products.filter(p=>!q||p.title.toLowerCase().includes(q)|| (p.desc||'').toLowerCase().includes(q))).forEach(p=>{
        const qtyInCart = getCartQty(p.id);
        const el=document.createElement('div');
        el.className='product';
        const mainImg = (p.images && p.images.length) ? p.images[0] : placeholder(p.title);
        let thumbsHtml = '';
        if(p.images && p.images.length>1){
          thumbsHtml = `<div class="productThumbs">` + p.images.map((img, idx) => `<img src="${img}" onclick="updateCardMainImage(this, '${p.id}', ${idx})">`).join('') + `</div>`;
        }
        el.innerHTML = `
          <div class="card-img-wrap">
            <img id="card_img_${p.id}" src='${mainImg}' onclick="openImageModalForProduct('${p.id}', 0)">
          </div>
          <h3>${p.title}</h3>
          <div class='muted'>${p.desc||''}</div>
          ${thumbsHtml}
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class='price'>${formatPrice(p.price)}</div>
            <div class="qty-controls">
              <button class="small-btn" onclick="decreaseProductQtyInGrid('${p.id}')">‚àí</button>
              <div style="min-width:30px;text-align:center">${qtyInCart}</div>
              <button class="small-btn" onclick="increaseProductQtyInGrid('${p.id}')">+</button>
            </div>
          </div>
          <div style='display:flex;gap:8px;margin-top:8px'>
            <button onclick="openProductModal('${p.id}')">${(currentLang==='ar'?'ÿπÿ±ÿ∂':'Voir')}</button>
            <button onclick="addToCart('${p.id}',1)">${t('add_product')}</button>
          </div>`;
        grid.appendChild(el);
      });
      if(grid.innerHTML.trim()==='') grid.innerHTML = `<div class="muted">${t('no_products')}</div>`;
    }

    function updateCardMainImage(imgEl, productId, idx){
      const cardImg = byId('card_img_'+productId);
      if(cardImg) cardImg.src = imgEl.src;
    }

    // --- Product modal handling (reads from products[] cache) ---
    let modalProduct=null;
    function openProductModal(id){
      const p = products.find(x=>x.id===id);
      if(!p) return;
      modalProduct=p;
      const main = p.images && p.images.length ? p.images[0] : placeholder(p.title);
      byId('productMainImg').src = main;
      byId('modalTitle').textContent = p.title;
      byId('modalDesc').textContent = p.desc||'';
      byId('modalQty').value = 1;
      updateModalPrice();
      const thumbs = byId('productThumbs');
      thumbs.innerHTML='';
      (p.images||[]).forEach((img,i)=>{
        const im=document.createElement('img'); im.src=img; im.className='thumb'; im.onclick=()=>byId('productMainImg').src=img; thumbs.appendChild(im);
      });
      byId('modalAddBtn').textContent = t('add_product');
      byId('closeProductModalBtn').textContent = t('close');
      byId('productModal').style.display='flex';
    }
    function closeProductModal(){ byId('productModal').style.display='none'; isPreviewMode=false; }
    function increaseModalQty(){ const q=Number(byId('modalQty').value)||1; byId('modalQty').value=q+1; updateModalPrice(); }
    function decreaseModalQty(){ const q=Number(byId('modalQty').value)||1; if(q>1) byId('modalQty').value=q-1; updateModalPrice(); }
    function updateModalPrice(){ if(!modalProduct) return; const q=Number(byId('modalQty').value)||1; byId('modalPrice').textContent = formatPrice(modalProduct.price*q); }

    // --- IMAGE modal code (same as before) ---
    let modalImageList = [];
    let modalImageIndex = 0;
    let imageScale = 1;
    let lastTouchDist = null;
    let wheelHandlerAttached = false;
    let touchHandlersAttached = false;
    const IMAGE_STAGE_ID = 'imageStage';

    function openImageModalForProduct(productId, startIndex=0){
      const p = products.find(x=>x.id===productId);
      let imgs = [];
      if(p && p.images && p.images.length) imgs = p.images.slice();
      if(imgs.length===0){
        imgs = [placeholder('Image')];
      }
      openImageModal(imgs, startIndex);
    }

    function openImageModal(images, startIndex=0){
      modalImageList = images.slice();
      modalImageIndex = Math.max(0, Math.min(startIndex, modalImageList.length-1));
      imageScale = 1;
      lastTouchDist = null;
      const stage = byId(IMAGE_STAGE_ID);
      stage.innerHTML = '';
      const img = document.createElement('img');
      img.src = modalImageList[modalImageIndex];
      img.className = 'image-slide-active';
      img.style.opacity = 1;
      img.dataset.idx = modalImageIndex;
      stage.appendChild(img);
      byId('imageModal').style.display = 'flex';
      attachImageHandlers(stage);
    }

    function attachImageHandlers(stage){
      const img = stage.querySelector('img');
      if(!img) return;
      if(!wheelHandlerAttached){
        stage.addEventListener('wheel', imageWheelHandler, {passive:false});
        wheelHandlerAttached = true;
      }
      if(!touchHandlersAttached){
        stage.addEventListener('touchstart', imageTouchStart, {passive:false});
        stage.addEventListener('touchmove', imageTouchMove, {passive:false});
        stage.addEventListener('touchend', imageTouchEnd, {passive:false});
        touchHandlersAttached = true;
      }
      document.addEventListener('keydown', keyboardImageNav);
    }

    function detachImageHandlers(stage){
      if(wheelHandlerAttached){
        stage.removeEventListener('wheel', imageWheelHandler);
        wheelHandlerAttached = false;
      }
      if(touchHandlersAttached){
        stage.removeEventListener('touchstart', imageTouchStart);
        stage.removeEventListener('touchmove', imageTouchMove);
        stage.removeEventListener('touchend', imageTouchEnd);
        touchHandlersAttached = false;
      }
      document.removeEventListener('keydown', keyboardImageNav);
    }

    function nextImage(){
      if(modalImageList.length <= 1) return;
      const stage = byId(IMAGE_STAGE_ID);
      const old = stage.querySelector('img');
      const nextIdx = (modalImageIndex + 1) % modalImageList.length;
      const incoming = document.createElement('img');
      incoming.src = modalImageList[nextIdx];
      incoming.dataset.idx = nextIdx;
      incoming.className = '';
      incoming.style.opacity = 0;
      incoming.style.transform = 'translate(-40%,-50%)';
      stage.appendChild(incoming);
      requestAnimationFrame(() => {
        incoming.style.transition = 'transform 0.45s ease, opacity 0.38s ease';
        old.style.transition = 'transform 0.45s ease, opacity 0.38s ease';
        incoming.style.transform = 'translate(-50%,-50%)';
        incoming.style.opacity = 1;
        old.style.transform = 'translate(-60%,-50%)';
        old.style.opacity = 0;
        setTimeout(()=>{
          if(old && old.parentNode) old.parentNode.removeChild(old);
          modalImageIndex = nextIdx;
          imageScale = 1;
          setImageScale(1);
        }, 420);
      });
    }

    function prevImage(){
      if(modalImageList.length <= 1) return;
      const stage = byId(IMAGE_STAGE_ID);
      const old = stage.querySelector('img');
      const prevIdx = (modalImageIndex - 1 + modalImageList.length) % modalImageList.length;
      const incoming = document.createElement('img');
      incoming.src = modalImageList[prevIdx];
      incoming.dataset.idx = prevIdx;
      incoming.className = '';
      incoming.style.opacity = 0;
      incoming.style.transform = 'translate(-60%,-50%)';
      stage.appendChild(incoming);
      requestAnimationFrame(() => {
        incoming.style.transition = 'transform 0.45s ease, opacity 0.38s ease';
        old.style.transition = 'transform 0.45s ease, opacity 0.38s ease';
        incoming.style.transform = 'translate(-50%,-50%)';
        incoming.style.opacity = 1;
        old.style.transform = 'translate(-40%,-50%)';
        old.style.opacity = 0;
        setTimeout(()=>{
          if(old && old.parentNode) old.parentNode.removeChild(old);
          modalImageIndex = prevIdx;
          imageScale = 1;
          setImageScale(1);
        }, 420);
      });
    }

    function closeImageModal(){
      const stage = byId(IMAGE_STAGE_ID);
      detachImageHandlers(stage);
      stage.innerHTML = '';
      modalImageList = [];
      modalImageIndex = 0;
      imageScale = 1;
      lastTouchDist = null;
      byId('imageModal').style.display = 'none';
    }

    function resetImageZoom(){
      imageScale = 1;
      setImageScale(1);
    }

    function setImageScale(scale){
      const stage = byId(IMAGE_STAGE_ID);
      const img = stage.querySelector('img');
      if(img) img.style.transform = `translate(-50%,-50%) scale(${scale})`;
    }

    function imageWheelHandler(e){
      e.preventDefault();
      const delta = -e.deltaY;
      const step = delta > 0 ? 0.12 : -0.12;
      imageScale = Math.min(5, Math.max(1, imageScale + step));
      setImageScale(imageScale);
    }

    function getTouchDistance(touches){
      const [a,b] = touches;
      const dx = a.clientX - b.clientX;
      const dy = a.clientY - b.clientY;
      return Math.sqrt(dx*dx + dy*dy);
    }
    function imageTouchStart(e){
      if(e.touches.length === 2){
        lastTouchDist = getTouchDistance(e.touches);
      }
    }
    function imageTouchMove(e){
      if(e.touches.length === 2 && lastTouchDist){
        e.preventDefault();
        const cur = getTouchDistance(e.touches);
        const factor = cur / lastTouchDist;
        imageScale = Math.min(5, Math.max(1, imageScale * factor));
        setImageScale(imageScale);
        lastTouchDist = cur;
      }
    }
    function imageTouchEnd(e){
      if(e.touches.length < 2){
        lastTouchDist = null;
      }
    }

    function keyboardImageNav(e){
      if(byId('imageModal').style.display !== 'flex') return;
      if(e.key === 'ArrowLeft') prevImage();
      if(e.key === 'ArrowRight') nextImage();
      if(e.key === 'Escape') closeImageModal();
    }

    // --- CART: stored in Firestore under collection "carts" with doc id = clientId
    async function loadCartForClient(){
      cart = [];
      if(!currentClient) { renderCart(); return; }
      const doc = await db.collection('carts').doc(currentClient.id).get();
      if(doc.exists){
        cart = doc.data().items || [];
      } else {
        cart = [];
      }
      renderCart();
    }
    async function saveCartForClient(){
      if(!currentClient) return;
      await db.collection('carts').doc(currentClient.id).set({ items: cart, updated: firebase.firestore.FieldValue.serverTimestamp() });
    }

    function addToCart(id,qty=1){
      if(!currentClient){ alert(t('must_be_logged')); return; }
      const p = products.find(x=>x.id===id);
      if(!p){ alert(t('product_not_found')); return; }
      const it = cart.find(x=>x.id===id);
      if(it){ it.qty += qty; } else { cart.push({ id, title:p.title, price:p.price, qty }); }
      saveCartForClient();
      renderCart();
      renderProducts();
    }

    function renderCart(){
      const el=byId('cartList');
      el.innerHTML='';
      if(!cart || cart.length===0){ el.innerHTML=`<div class="muted">${t('cart_empty')}</div>`; byId('cartTotal').textContent='0 DA'; return; }
      const table=document.createElement('table'); const tbody=document.createElement('tbody'); let total=0;
      cart.forEach((c,i)=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${c.title} x${c.qty}</td><td style="text-align:right">${c.price*c.qty} DA</td>`; tbody.appendChild(tr); total+=c.price*c.qty; });
      table.appendChild(tbody); el.appendChild(table); byId('cartTotal').textContent = total+' DA';
    }

    async function clearCart(){
      cart = [];
      if(currentClient) await db.collection('carts').doc(currentClient.id).set({ items: [] });
      renderCart(); renderProducts();
    }

    function increaseProductQtyInGrid(id){
      addToCart(id,1);
      renderProducts();
    }
    function decreaseProductQtyInGrid(id){
      const it = cart.find(c=>c.id===id);
      if(!it) return;
      it.qty = it.qty - 1;
      if(it.qty <= 0){
        cart = cart.filter(x=>x.id!==id);
      }
      saveCartForClient();
      renderCart();
      renderProducts();
    }

    // --- CHECKOUT & ORDERS ---
    function openCartCheckout(){ if(!currentClient){ alert(t('must_be_logged')); return; } if(!cart || cart.length===0){ alert(t('cart_empty')); return; } showInvoiceModal(); }

    function showInvoiceModal(){
      const inv={ date:new Date().toISOString(), client:{ id: currentClient.id, nom: currentClient.nom, prenom: currentClient.prenom, tel: currentClient.tel, loc: currentClient.loc }, items: cart.map(c=>({ title:c.title, qty:c.qty, subtotal:c.qty*c.price, price:c.price })), total: cart.reduce((s,i)=>s+i.qty*i.price,0) };
      window.pendingInvoice = inv;
      const panel=byId('invoicePanel');
      let html=`<div style='display:flex;justify-content:space-between;align-items:center'><div><h3>${t('invoice_title')}</h3><div class='muted'>${t('supplier_line')}</div></div><div>${new Date(inv.date).toLocaleString()}</div></div><hr>`;
      html += `<div><strong>${t('account')}:</strong> ${inv.client.nom} ${inv.client.prenom} ‚Äî ${inv.client.tel} ‚Äî ${inv.client.loc}</div>`;
      html += `<table style='margin-top:8px'><thead><tr><th>${t('article')}</th><th>${t('qty')}</th><th>${t('price')}</th></tr></thead><tbody>`;
      inv.items.forEach(it=>{ html += `<tr><td>${it.title}</td><td>${it.qty}</td><td>${it.subtotal} DA</td></tr>` });
      html += `</tbody></table><div style='text-align:right;margin-top:8px'><strong>${t('total')}: ${inv.total} DA</strong></div>`;
      html += `<div style='text-align:right;margin-top:12px'><button style="background:#16a34a;color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer" onclick='confirmInvoice()'>Confirmer</button> <button style="background:#f87171;color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer" onclick='closeInvoiceModal()'>Annuler</button></div>`;
      panel.innerHTML = html;
      byId('invoiceModal').style.display='flex';
    }

    async function closeInvoiceModal(){ byId('invoiceModal').style.display='none'; }

    // Confirm save: create commande in Firestore, clear cart
    async function confirmInvoice(){
      if(!window.pendingInvoice) return;
      if(!currentClient){ alert(t('must_be_logged')); return; }
      const inv = window.pendingInvoice;
      inv.clientId = currentClient.id;
      inv.date = new Date().toISOString();
      // add to Firestore collection "commandes"
      const docRef = await db.collection('commandes').add(inv);
      // clear cart in firestore
      await db.collection('carts').doc(currentClient.id).set({ items: [] });
      cart = [];
      renderCart();
      renderProducts();
      // UI updates
      byId('invoiceModal').style.display='none';
      renderClientOrders();
      alert(t('order_saved'));
      delete window.pendingInvoice;
    }

    // --- CLIENT auth & accounts (stored in Firestore "clients") ---
    function openClientAuth(){ byId('clientAuthModal').style.display='flex'; renderClientForm('exist'); }
    function closeClientForm(){ byId('clientAuthModal').style.display='none'; const area = byId('clientFormArea'); area.innerHTML=''; }

    function renderClientForm(mode){
      const area = byId('clientFormArea');
      if(mode==='new'){
        area.innerHTML = `
          <input class='input' id='c_nom' placeholder='${t('name')}'><br><br>
          <input class='input' id='c_prenom' placeholder='${t('surname')}'><br><br>
          <input class='input' id='c_tel' placeholder='${t('phone')}'><br><br>
          <input class='input' id='c_loc' placeholder='${t('location')}'><br><br>
          <button onclick="submitClient('new')">${t('save')}</button>
        `;
      } else {
        area.innerHTML = `
          <input class='input' id='c_nom' placeholder='${t('name')}'><br><br>
          <input class='input' id='c_prenom' placeholder='${t('surname')}'><br><br>
          <input class='input' id='c_tel' placeholder='${t('phone')}'><br><br>
          <button onclick="submitClient('exist')">${t('login')}</button>
        `;
      }
    }

    async function submitClient(mode){
      const nom = byId('c_nom')?.value?.trim();
      const prenom = byId('c_prenom')?.value?.trim();
      const tel = byId('c_tel')?.value?.trim();
      const loc = byId('c_loc')?.value?.trim();
      if(!nom||!prenom||!tel){ alert(t('fill_required')); return; }
      if(mode==='new' && !loc){ alert(t('location_required')); return; }
      if(mode==='new'){
        const client = { nom, prenom, tel, loc: loc||'', status:'pending', created: new Date().toISOString() };
        // add to Firestore
        const docRef = await db.collection('clients').add(client);
        // store local current client reference (in-memory)
        currentClient = { id: docRef.id, ...client };
        // create empty cart doc for client
        await db.collection('carts').doc(currentClient.id).set({ items: [] });
        closeClientForm();
        showPendingForClient(); renderSupplierPendingCount();
        alert(t('account_created_pending'));
      } else {
        // login: find client document with matching details and status validated
        const snapshot = await db.collection('clients').where('nom','==',nom).where('prenom','==',prenom).where('tel','==',tel).where('status','==','validated').get();
        if(!snapshot.empty){
          const doc = snapshot.docs[0];
          currentClient = { id: doc.id, ...doc.data() };
          closeClientForm();
          await loadCartForClient();
          enterHome();
        } else {
          alert(t('account_not_found'));
        }
      }
    }

    function showPendingForClient(){
      showOnly('initialScreen');
      const panel = byId('pendingNotice');
      panel.innerHTML = `<div style="background:#fff3cd;padding:12px;border-radius:8px;border:1px solid #ffeeba"><strong>${t('account_registered')}</strong><div class='muted'>${t('account_pending_description', {name: (currentClient? (currentClient.nom + ' ' + currentClient.prenom) : '')})}</div></div>`;
    }

    // --- SUPPLIER login / panel (password hardcoded) ---
    function openSupplierLogin(){ showOnly('supplierLoginSection'); byId('supplierPwd').value=''; renderSupplierPendingCount(); }
    function closeSupplierLogin(){ showOnly('initialScreen'); }
    function supplierLogin(){ const v = byId('supplierPwd').value.trim(); if(v===SUPPLIER_PWD){ showSupplierPanel(); } else { alert(t('incorrect_password')); } }

    function showSupplierPanel(){ byId('supplierLoginSection').style.display='none'; byId('supplierPanelSection').style.display='block'; showSupplierTab('clients'); renderSupplierPendingCount(); }

    function logoutSupplier(){ byId('supplierPanelSection').style.display='none'; showOnly('initialScreen'); }

    function renderInitialPendingNotice(){
      const pendingCount = clients.filter(c=>c.status==='pending').length;
      const el = byId('pendingNotice');
      if(pendingCount>0){
        el.innerHTML = `<div style="background:#fff3cd;padding:12px;border-radius:8px;border:1px solid #ffeeba"><strong>${pendingCount} nouveau(x) client(s) en attente</strong><div class='muted'>${t('supplier_protected')}</div></div>`;
      } else {
        el.innerHTML = '';
      }
    }

    function renderSupplierPendingCount(){
      const count = clients.filter(c=>c.status==='pending').length;
      const el = byId('pendingCount');
      if(el) el.textContent = count;
    }

    // Supplier tabs rendering helpers (clients/products/orders)
    function showSupplierTab(tab){
      const container = byId('supplierTabs');
      if(tab==='clients'){
        renderSupplierClientsTab();
        return;
      } else if(tab==='products'){
        renderSupplierProductsTab();
        return;
      } else if(tab==='orders'){
        renderSupplierOrdersTab();
        return;
      }
    }

    function renderSupplierClientsTab(){
      const container = byId('supplierTabs');
      let html = `<h4>${t('clients')}</h4>`;
      const pending = clients.filter(c=>c.status==='pending');
      const validated = clients.filter(c=>c.status==='validated');
      html += `<h5>${t('clients_pending')} (${pending.length})</h5>`;
      if(pending.length===0) html += `<div class="muted">${t('no_clients_pending')}</div>`;
      pending.forEach(c=>{
        html += `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid #f1f5f9"><div><strong>${c.nom} ${c.prenom}</strong><div class='muted'>${c.tel} ‚Äî ${c.loc}</div></div><div class="row"><button onclick="validateClient('${c.id}')">${t('accept')}</button><button class="input" onclick="rejectClient('${c.id}')">${t('reject')}</button></div></div>`;
      });
      html += `<h5 style='margin-top:12px'>${t('clients_validated')} (${validated.length})</h5>`;
      if(validated.length===0) html += `<div class="muted">${t('no_clients_validated')}</div>`;
      validated.forEach(c=>{
        html += `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid #f1f5f9"><div><strong>${c.nom} ${c.prenom}</strong><div class='muted'>${c.tel} ‚Äî ${c.loc}</div></div><div class="row"><button class='input' onclick="deleteClient('${c.id}')">${t('delete')}</button></div></div>`;
      });
      container.innerHTML = html;
    }

    function renderSupplierProductsTab(){
      const container = byId('supplierTabs');
      let html = `<h4>${t('products')}</h4>`;
      html += `<div style='display:flex;gap:8px;align-items:center'><input id='sp_title' class='input' placeholder='${t('name')}'><input id='sp_price' class='input' placeholder='${t('price') || "Prix"}'><input id='sp_desc' class='input' placeholder='${t('article') || "Description"}'><input type='file' id='sp_images' multiple accept='image/*'><button onclick='addProductFromSupplier()'>${t('add_product')}</button></div>`;
      html += '<div style="margin-top:12px">';
      if(products.length===0) html += `<div class="muted">${t('no_products')}</div>`;
      products.forEach((p,i)=>{
        html += `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid #f1f5f9"><div><strong>${p.title}</strong><div class='muted'>${p.price} DA ‚Äî ${p.desc}</div></div><div class='row'><button onclick="editProduct('${p.id}')">${t('edit')}</button><button class='input' onclick="deleteProduct('${p.id}')">${t('delete')}</button></div></div>`;
      });
      html += '</div>';
      container.innerHTML = html;
    }

    function renderSupplierProductsList(){
      // if supplier products tab is visible, refresh it
      if(byId('supplierTabs') && byId('supplierPanelSection') && byId('supplierPanelSection').style.display !== 'none'){
        const tab = byId('supplierTabs').querySelector('h4');
        if(tab && tab.textContent && tab.textContent.includes(t('products'))){
          renderSupplierProductsTab();
        }
      }
    }

    function renderSupplierOrdersTab(){
      const container = byId('supplierTabs');
      let html = `<h4>${t('bank_orders')}</h4>`;
      if(orders.length===0){ html += `<div class="muted">${t('no_orders')}</div>`; }
      let totalAll = 0;
      orders.forEach(o=>{
        html += `<div id="order_row_${o.id}" style='border:1px solid #eef6ff;padding:10px;border-radius:8px;margin-bottom:8px'><div style='display:flex;justify-content:space-between'><div><strong>${o.client.nom} ${o.client.prenom}</strong><div class='muted'>${o.client.tel} ‚Äî ${o.client.loc}</div></div><div class='muted'>${new Date(o.date).toLocaleString()}</div></div>`;
        html += '<table style="margin-top:8px"><thead><tr><th>'+t('article')+'</th><th>'+t('qty')+'</th><th>'+t('price')+'</th></tr></thead><tbody>';
        (o.items||[]).forEach(it=>{
          html += `<tr><td>${it.title}</td><td>${it.qty}</td><td>${it.subtotal} DA</td></tr>`;
        });
        html += `</tbody></table><div style='display:flex;justify-content:space-between;align-items:center;margin-top:8px'><div></div><div style='text-align:right'><strong>${t('total')}: ${o.total} DA</strong></div></div>`;
        html += `<div style='text-align:right;margin-top:8px'><button class='input' onclick="deleteOrder('${o.id}')">üóëÔ∏è Supprimer</button></div>`;
        html += `</div>`;
        totalAll += o.total || 0;
      });
      html += `<div style='margin-top:12px;text-align:right'><strong>${t('total_revenue')}: ${totalAll} DA</strong></div>`;
      container.innerHTML = html;
    }

    async function deleteOrder(orderId){
      if(!confirm('Supprimer cette commande ?')) return;
      await db.collection('commandes').doc(orderId).delete();
      alert('Commande supprim√©e');
    }

    async function validateClient(id){
      await db.collection('clients').doc(id).update({ status:'validated' });
      alert(t('client_validated'));
    }
    async function rejectClient(id){
      await db.collection('clients').doc(id).delete();
      alert(t('client_refused'));
    }
    async function deleteClient(id){
      await db.collection('clients').doc(id).delete();
      alert(t('client_deleted'));
    }

    // --- PRODUCTS management with Storage (multiple images allowed) ---
    function readFileAsDataURL(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); }); }

    async function addProductFromSupplier(){
      const ttitle = (byId('sp_title')||{value:''}).value.trim();
      const pprice = Number((byId('sp_price')||{value:0}).value)||0;
      const d = (byId('sp_desc')||{value:''}).value.trim();
      const files = (byId('sp_images')||{}).files;
      if(!ttitle || !pprice){ alert(t('title_price_required')); return; }

      // upload files to storage if present
      let uploadedUrls = [];
      if(files && files.length){
        // upload each file under produits/<timestamp>_<filename>
        for(const f of Array.from(files)){
          const path = `produits/${Date.now()}_${f.name.replace(/\s/g,'_')}`;
          const ref = storage.ref().child(path);
          await ref.put(f);
          const url = await ref.getDownloadURL();
          uploadedUrls.push(url);
        }
      }

      // create product doc in Firestore
      const prod = { title: ttitle, price: pprice, desc: d, images: uploadedUrls, created: firebase.firestore.FieldValue.serverTimestamp() };
      await db.collection('produits').add(prod);

      // clear supplier inputs and refresh supplier tab
      if(byId('sp_title')) byId('sp_title').value='';
      if(byId('sp_price')) byId('sp_price').value='';
      if(byId('sp_desc')) byId('sp_desc').value='';
      if(byId('sp_images')) byId('sp_images').value='';
      alert(t('product_added'));
    }

    async function deleteProduct(id){
      // optional: delete images from storage (not implemented automatically to avoid accidental deletion)
      await db.collection('produits').doc(id).delete();
      alert(t('product_deleted'));
    }

    async function editProduct(id){
      const doc = await db.collection('produits').doc(id).get();
      if(!doc.exists) { alert(t('product_not_found')); return; }
      const p = { id: doc.id, ...doc.data() };
      const tnew = prompt(t('name'), p.title);
      if(tnew===null) return;
      const pr = prompt(t('price') || 'Prix', p.price);
      if(pr===null) return;
      const d = prompt(t('article') || 'Description', p.desc||'');
      await db.collection('produits').doc(id).update({ title: tnew, price: Number(pr)||p.price, desc: d });
      alert(t('product_modified'));
    }

    // --- Supplier Preview (keeps same UI; preview cart ephemeral in-memory) ---
    let supplierPreviewCart = [];
    let isPreviewMode = false;

    function showPreviewTab(){
      const container = byId('supplierTabs');
      let html = `<h4>${t('preview')}</h4>`;
      html += `<div style='display:flex;gap:8px;align-items:center;margin-bottom:8px'><div class="muted">${t('preview_sub')}</div></div>`;
      html += `<div id='previewProducts'></div>`;
      html += `<div style='margin-top:12px' id='previewCartArea'></div>`;
      container.innerHTML = html;
      renderPreviewProducts();
      renderPreviewCart();
    }

    function renderPreviewProducts(){
      const grid = byId('previewProducts'); grid.innerHTML = '';
      products.forEach(p=>{
        const el = document.createElement('div'); el.className='product'; el.style.marginBottom='8px';
        el.innerHTML = `<img src='${p.images && p.images.length? p.images[0] : placeholder(p.title)}' onclick="openProductModalPreview('${p.id}')"><h3>${p.title}</h3><div class='muted'>${p.desc||''}</div><div class='price'>${formatPrice(p.price)}</div><div style='display:flex;gap:8px;margin-top:8px'><button onclick="openProductModalPreview('${p.id}')">${(currentLang==='ar'?'ÿπÿ±ÿ∂':'Voir')}</button><button onclick="addToPreviewCart('${p.id}',1)">${t('add_product')}</button></div>`;
        grid.appendChild(el);
      });
    }

    function addToPreviewCart(id,qty=1){ const p = products.find(x=>x.id===id); if(!p){ alert(t('product_not_found')); return; } const it = supplierPreviewCart.find(x=>x.id===id); if(it){ it.qty += qty } else { supplierPreviewCart.push({id, title:p.title, price:p.price, qty}) } renderPreviewCart(); }

    function renderPreviewCart(){ const area = byId('previewCartArea'); let html = `<h4>${t('preview_cart')}</h4>`; if(supplierPreviewCart.length===0){ html += `<div class="muted">${t('preview_cart_empty')}</div>`; } else { html += '<table><tbody>'; let total=0; supplierPreviewCart.forEach(it=>{ html += `<tr><td>${it.title} x${it.qty}</td><td style="text-align:right">${it.price*it.qty} DA</td></tr>`; total += it.price*it.qty; }); html += `</tbody></table><div style='text-align:right;margin-top:8px'><strong>${t('total')}: ${total} DA</strong></div><div style='margin-top:8px;display:flex;gap:8px'><button onclick="confirmPreviewOrder()">${t('confirm_preview')}</button><button onclick="clearPreviewCart()" class='input'>${t('clear_cart')}</button></div>`; }
      area.innerHTML = html;
    }

    function clearPreviewCart(){ supplierPreviewCart = []; renderPreviewCart(); }

    function confirmPreviewOrder(){ if(supplierPreviewCart.length===0){ alert(t('preview_cart_empty')); return; }
      const previewOrder = { id:'PREV-'+Date.now(), date:new Date().toISOString(), client:{nom:'(Preview)',prenom:'(Preview)',tel:'',loc:'Preview'}, items:supplierPreviewCart.map(c=>({title:c.title,qty:c.qty,subtotal:c.price*c.qty})), total:supplierPreviewCart.reduce((s,i)=>s+i.qty*i.price,0) };
      const panel = byId('invoicePanel'); let html = `<div style='display:flex;justify-content:space-between;align-items:center'><div><h3>${t('preview_invoice_title')}</h3><div class='muted'>${t('preview_not_saved')}</div></div><div>${new Date(previewOrder.date).toLocaleString()}</div></div><hr>`;
      html += `<table style='margin-top:8px'><thead><tr><th>${t('article')}</th><th>${t('qty')}</th><th>${t('price')}</th></tr></thead><tbody>`;
      previewOrder.items.forEach(it=>{ html += `<tr><td>${it.title}</td><td>${it.qty}</td><td>${it.subtotal} DA</td></tr>`; });
      html += `</tbody></table><div style='text-align:right;margin-top:8px'><strong>${t('total')}: ${previewOrder.total} DA</strong></div>`;
      html += `<div style='margin-top:12px;text-align:center'><img src='data:image/svg+xml;utf8,${encodeURIComponent("<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"300\" height=\"80\"><rect width=\"100%\" height=\"100%\" fill=\"#e6f0ff\"/><text x=\"50%\" y=\"50%\" dominant-baseline=\"middle\" text-anchor=\"middle\" font-size=16 fill=\"#0b3d91\">Aper√ßu de bon de commande</text></svg>")}' alt='preview'></div>`;
      panel.innerHTML = html + `<div style='text-align:right;margin-top:8px'><button onclick='closeInvoiceModal()'>${t('close')}</button></div>`;
      byId('invoiceModal').style.display='flex';
    }

    function openProductModalPreview(id){ isPreviewMode = true; openProductModal(id); }

    // --- client orders rendering: query commandes where clientId == currentClient.id
    async function renderClientOrders(){
      const list = byId('clientOrdersList');
      if(!currentClient){
        list.innerHTML = "<div class='muted'>Connectez-vous pour voir vos commandes</div>";
        return;
      }
      // query commandes for this client
      const snapshot = await db.collection('commandes').where('clientId','==',currentClient.id).orderBy('date','desc').get();
      const clientOrders = snapshot.docs.map(d=> ({ id: d.id, ...d.data() }) );
      if(clientOrders.length === 0){
        list.innerHTML = "<div class='muted'>Aucune commande</div>";
        return;
      }
      let html = "<table style='width:100%'><tbody>";
      clientOrders.forEach(o=>{
        html += `<tr><td><strong>${new Date(o.date).toLocaleDateString()}</strong></td><td>${(o.items||[]).map(it=>`${it.title} x${it.qty}`).join(", ")}</td><td style="text-align:right">${o.total} DA</td></tr>`;
      });
      html += "</tbody></table>";
      list.innerHTML = html;
    }

    // --- account UI & session (in-memory) ---
    function renderAccountBlock(){
      const block=byId('accountBlock');
      if(currentClient && currentClient.status==='validated'){
        block.innerHTML = `<div><strong>${currentClient.nom} ${currentClient.prenom}</strong><div class='muted'>${currentClient.tel} ‚Äî ${currentClient.loc}</div><div style='margin-top:8px'><button onclick='logoutClient()'>${t('close')}</button></div></div>`;
        showOnly('homeScreen');
      } else {
        block.innerHTML = `<div class='muted'>${t('no_client_connected')}</div><div style='margin-top:8px'><button onclick='openClientAuth()'>${t('client_auth_btn')}</button></div>`;
        showOnly('initialScreen');
      }
    }

    function logoutClient(){ currentClient=null; cart=[]; renderAccountBlock(); showOnly('initialScreen'); }

    async function enterHome(){
      if(!currentClient){ alert(t('no_client_connected')); return; }
      if(currentClient.status!=='validated'){ alert(t('account_not_validated')); return; }
      await loadCartForClient();
      showOnly('homeScreen');
      renderProducts();
      renderCart();
      renderClientOrders();
    }

    function showOnly(id){
      const sections=['initialScreen','homeScreen','supplierLoginSection','supplierPanelSection'];
      sections.forEach(s=>{ const el=byId(s); if(el) el.style.display='none'; });
      const sel=byId(id); if(sel) sel.style.display='block';
    }

    // --- utility: render supplier pending count on start & when clients change ---
    // (renderSupplierPendingCount invoked by onSnapshot earlier)

    // --- initialization ---
    function init(){
      applyLanguage('fr');
      startRealtimeListeners();
      // initial empty render (data will arrive via onSnapshot)
      renderProducts();
      renderCart();
      renderSupplierPendingCount();
      renderInitialPendingNotice();
    }

    // expose functions globally used in html
    window.openClientAuth=openClientAuth; window.openSupplierLogin=openSupplierLogin; window.supplierLogin=supplierLogin; window.closeSupplierLogin=closeSupplierLogin; window.logoutSupplier=logoutSupplier; window.showSupplierTab=showSupplierTab; window.addToCart=addToCart; window.renderProducts=renderProducts; window.renderCart=renderCart; window.clearCart=clearCart; window.openProductModal=openProductModal; window.closeProductModal=closeProductModal; window.increaseModalQty=increaseModalQty; window.decreaseModalQty=decreaseModalQty; window.addFromModal=addFromModal; window.openCartCheckout=openCartCheckout; window.readFileAsDataURL=readFileAsDataURL; window.deleteProduct=deleteProduct; window.validateClient=validateClient; window.rejectClient=rejectClient; window.deleteClient=deleteClient; window.editProduct=editProduct; window.logoutClient=logoutClient; window.enterHome=enterHome; window.renderInitialPendingNotice=renderInitialPendingNotice; window.increaseProductQtyInGrid=increaseProductQtyInGrid; window.decreaseProductQtyInGrid=decreaseProductQtyInGrid; window.deleteOrder=deleteOrder; window.resetImageZoom=resetImageZoom; window.openImageModal=openImageModal; window.openImageModalForProduct=openImageModalForProduct; window.nextImage=nextImage; window.prevImage=prevImage; window.openProductModalPreview=openProductModalPreview;

    // --- small function used by modal addFromModal to add to cart or preview ---
    function addFromModal(){ const q=Number(byId('modalQty').value)||1; if(isPreviewMode){ addToPreviewCart(modalProduct.id,q); isPreviewMode=false; closeProductModal(); renderPreviewCart(); } else { addToCart(modalProduct.id,q); closeProductModal(); } }

    // start
    init();
  </script>
</body>
</html>
